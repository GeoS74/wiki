# Агрегация

Чтобы использовать агрегацию в $lookup (это работает в версиях монги 5 и выше):

```
...
{
	$lookup: {
          from: 'prices',
          localField: '_id',
          foreignField: 'nomenclatureId',
          as: 'price',
          pipeline: [{ $sort: { createdAt: -1 } }, { $limit: 1 }],
        },
      },
...
```

То же самое для версии 4.0 и выше:
```
{
	$lookup: {
          from: 'prices',
          let: {currentId: "$_id"},
          pipeline: [
            {
              $match: {
                $expr: {
                  $eq: ["$nomenclatureId", "$$currentId"]
                },
              }
            },
            { $sort: { createdAt: -1 } }, 
			{ $limit: 1 }
			],
          as: 'price',
        },
      },
```