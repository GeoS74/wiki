# Про чанки и highWaterMark
Немного про [[Стримы|стримы]] в [[NodeJS]]

Кириллица в кодировке utf-8 имеет 2 байта, латиница - 1 байт. Пример ниже показывает как бьётся кодировка если не предусмотреть эту ситуацию заранее.
На входе есть файл `text.txt`, в который записаны 20 букв "ф":

```
фффффффффффффффффффф
```

Скрипт пытается считать эти буквы, но highWaterMark говорит, что нужно читать по 9 байт. Т.к. кириллица записывается с использованием 2 байтов, то возникает ситуация когда буква, записанная 2-мя байтами "бьется пополам".

```
const fs = require('fs');

const reader = fs.createReadStream('text.txt', {highWaterMark: 9});

reader.on('data', chunk => {
  console.log(chunk.toString('utf-8'))
});
```

Вывод этого скрипта:
```
фффф�
�фффф
фффф�
�фффф
фф
```

Можно вывести чанки в шестнадцатиричном представлении, чтобы увидеть как 2-х байтный символ "ломается"

```
reader.on('data', chunk => console.log(chunk));
```

Выведет в консоль:

```
<Buffer d1 84 d1 84 d1 84 d1 84 d1>
<Buffer 84 d1 84 d1 84 d1 84 d1 84>
<Buffer d1 84 d1 84 d1 84 d1 84 d1>
<Buffer 84 d1 84 d1 84 d1 84 d1 84>
<Buffer d1 84 d1 84>
```


Для обработки этой ситуации можно записать все чанки в массив, а в конце объединить чанки и преобразовать в нужную кодировку. Или указать кодировку при создании [[Стримы|стрима]] (см. закомментированные строки) 

```
const fs = require('fs');

const stream = fs.createReadStream('text.txt', {
	highWaterMark: 9,
	// encoding: 'utf-8' //кодировка вариант 1
});
// stream.setEncoding('utf-8') //кодировка вариант 2

const data = [];
stream.on('data', chunk => {
	data.push(chunk);
	// console.log(chunk.toString('utf-8'))
});

stream.on('end', () => {
	console.log(Buffer.concat(data).toString('utf-8')); //кодировка вариант 3
})
```

При указании кодировки в вариантах 1 или 2 вывод будет примерно таким:
```
фффф
ффффф
фффф
ффффф
фф
```

>BEST PRACTICES
лучше всего в [[Стримы|стримах]] работать с байтами, а только в конце преобразовывать в нужную кодировку. Вариант 3 предпочтительней.


Проблема кодировок в основном относится только к строкам или текстовым данным.

#chank #highwatermark