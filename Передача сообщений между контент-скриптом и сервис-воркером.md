# Передача сообщений между контент-скриптом и сервис-воркером

[Документация](https://developer.chrome.com/docs/extensions/mv3/messaging/#connect)
[Документация по chrome.runtime](https://developer.chrome.com/docs/extensions/reference/runtime/)

[[Browser plugins|Расширение браузера]] может использовать контент-скрипты и сервис-воркеры. Контент-скрипт это код, который вызывается плагином для каждой страницы, открытой в браузере. Сервис-воркер - это фоновый js код.

Код сервис-воркера имеет меньше ограничений, например, если надо чтобы плагин делал fetch запросы на сторонние сервера, то код из контент-скрипта будет попадать под CORS, Mixed content (если ресурс загружен по https, а сторонний сервер на http) и т.д. При этом fetch запросы видны в консоли разработчика. С другой стороны, fetch запросы из сервис-воркера под такие ограничения не попадают, но код сервис-воркера не имеет доступа к вкладке браузера.

Из этого вытекает то, что надо иметь механизм передачи сообщений между контент-скриптом и сервис-воркером. Вот рабочий пример как это написать:

content-script
```js
// устанавливаем связь с сервис-воркером, прокидывая имя контент-скрипта (необязательно)
const port = chrome.runtime.connect({name: 'content'});

// обработчик слушает сообщения от сервис-воркера
port.onMessage.addListener((message) => {
	console.log(message);
});

// отправляем сообщение сервис-воркеру
port.postMessage({hello: "world"});
```

service-worker
```js
// обработчик слушает событие подключения контент-скрипта
chrome.runtime.onConnect.addListener((port) => {

  // здесь можно поймать имя контент-скрипта и реализовать какую-то логику для определённой страницы
  if(port.name === 'content') {...}

  // отправляем сообщение контент-скрипту
  port.postMessage({foo: 'bar'});

  // добавляем обработчик слушателя сообщений от контент скрипта
  port.onMessage.addListener((message) => {
	  console.log(message);
	  // отвечаем обратно контент-скрипту
	  port.postMessage({foo: 'bar'});
  });

});
```