# Создание справочник. Вариант с PostgreSQL

[Исходник базы данных КЛАДР](https://fias.nalog.ru/Frontend)

Справочник городов выглядит примерно так:

 id  |   name       | socr |     code      | index | gninmb | uno  |    ocatd    | status
-----+----------+------+---------------+-------+--------+------+-------------+--------
   2 | Майкоп     | г     | 0100000100000 |       | 0100   |      | 79401000000 | 0
  59 | Адыгейск | г      | 0100000200000 |       | 0100   | 0107 | 79403000000 | 0
 469 | Уфа          | г     | 0200000100000 |       | 0200   |      | 80401000000 | 0

> Прим.: поле `index` изначально пустое, поле `status` для всех записей содержит только `0`.


Далее описывается создание справочника городов. Если надо его расширить, используя деревни, посёлки и т.д. - надо пересмотреть шаг 1.

### step 1

 Для начала надо выделить из таблицы только города и субъекты РФ. Код [[КЛАДР]] субъекта использует только первые 2 цифры кода, остальные нули. С кодами городов всё сложнее, так как города могут иметь несколько кодов (надо посмотреть расшифровку кода КЛАДР). Чтобы отсеять лишнюю информацию надо брать коды городов у которых 2 последних символа это нули, а поле `socr` содержит `г`.

Т.к. поле `status` заполнено только `0`, то можно его использовать для выделения городов и субъектов. Для субъектов установить значение `1`, для городов - `2`.

```sql
# выделить города
UPDATE _cities SET status='2' WHERE socr='г' AND code LIKE '___________00';

# выделить регионы
UPDATE _cities SET status='1' WHERE code LIKE '__00000000000';
```

Запросы надо делать именно в таком порядке, т.к. в справочнике есть города, которые являются обособленными и не относятся к областям. Их следует отнести к регионам (в поле `status` записать 1).  Если изменить порядок, то для этих городов будет установлен `status` 2 и далее ряд небольших городов не сопоставится с регионом (читай дальше).

Список особых городов:
- Москва (код КЛАДР 7700000000000)
- Санкт-Петербург (код КЛАДР 7800000000000)
- Байконур (код КЛАДР 9900000000000)
- Севастополь (код КЛАДР 9200000000000)

У этих городов код [[КЛАДР]] выглядит также как и у субъектов РФ (используются только первые 2 цифры, остальные нули).

> В справочнике есть города для которых эти обособленные города являются регионом. Например Зеленоград (код 7700000200000). Такие города должны попасть в справочник с полным именем: Зеленоград г. (Москва г.), при этом г. Москва в справочнике должна отображаться без региона.

Подсказка: после этого шага можно удалить все записи для которых поле `status` содержит 0, оставив тем самым только города и субъекты РФ.
### step 2

Исправление неоднозначности в справочнике: поле `socr` для всех записей содержит значения типа `г` для городов,  `пгт` для посёлков городского типа,  `д` для деревень и т.д. Исключением является запись о Чувашской республике, у которой в поле `socr` стоит `Чувашия`, в поле `name` значится `Чувашская Республика -`. Возможно это не является ошибкой, но надо это привести к общему знаменателю.

```sql
update _cities set name='Чувашская', socr='Респ' where socr='Чувашия';
```

 
### step 3

Добавить новые столбцы:
- regcode::text (2-х значный код региона)
- regname::text (субъект РФ, к которому относится город)
- fullname::text (название города и субъекта, напр.: `Зеленоград г. (Москва г.)`). Именно такое представление будет использоваться в [[Универсальный калькулятор|калькуляторе]] при выборе населённого пункта

```sql
alter table _cities 
	add column regcode text, 
	add column regname text, 
	add column fullname text
;
```

Изменить тип столбца `index` на массив:
- index::text[] (этот столбец будет содержать массив индексов, относящихся к конкретному городу)

 ```sql
alter table _cities 
	alter index type text[] using index::text[]
;
```


### step 4

Заполнить код региона для каждой записи.

 ```sql
update _cities set regcode=left(code, 2);
```


### step 5

Сопоставить города и субъекты РФ.

 ```sql
update _cities C 
	set regname=(
		select concat(
			name, 
			' ', 
			lower(socr), 
			case lower(socr) 
				when 'край' then'' 
				when 'чувашия' then '' 
				else '.' 
			end
		) 
		from _cities T 
		where T.regcode=C.regcode and status='1' limit 1);
```

Очистить поле `regname` для обособленных городов

```sql
update _cities 
	set regname='' 
	where name in ('Москва', 'Байконур', 'Санкт-Петербург', 'Севастополь');
```

### step 6

Заполнить полное наименование населённого пункта.

```sql
update _cities 
	set fullname=concat(
		name, 
		' ', 
		socr, 
		'.',  
		case regname 
			when '' then '' 
			else concat(' (', regname, ')') 
		end
);
```

### step 7

Удалить из таблицы субъекты, оставив только города.

```sql
delete from _cities where status='1' and socr!='г';
```

### step 8

Заполнить массив индексов по каждому городу. Т.к. справочник улиц достаточно большой, то надо использовать временную таблицу.

> Код улицы состоит из 17 символов против 13 символов кода города, поэтому в запросе надо код улицы урезать до длины кода города.

```sql
# создать временную таблицу на основе справочника улиц
create table tmp as
  select S.index, C.code from streets S
    right join _cities C
    on C.code=substring(S.code, '.{13}')
;

update _cities C 
	set index=array(select index from tmp T where T.code=C.code);
```


### Profit

Справочник городов готов! Можно использовать.



### Вспомогательные запросы

1. сравнить длину кодов городов и улиц

```sql
select distinct length(code) from cities;
select distinct length(code) from streets;
```

#кладр