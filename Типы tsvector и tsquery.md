# Типы tsvector и tsquery

Для реализации [[Полнотекстовый поиск|полнотекстового]] поиска в [[PostgreSQL]] документ, по которому выполняется поиск должен быть приведен к типу `tsvector`, а запрос - `tsquery`

### tsvector

Значение типа `tsvector` содержит отсортированный список неповторяющихся _лексем_, т. е. слов, _нормализованных_ так, что все словоформы сводятся к одной. Сортировка и исключение повторяющихся слов производится автоматически при вводе значения.

Само по себе приведение строки к типу tsvector не производит преобразование слов к лексемам. Пример:
```sql
select 'ты вчера был в гостях в Москве?'::tsvector;

 tsvector
-------------------------------------------
 'Москве?' 'был' 'в' 'вчера' 'гостях' 'ты'
```

Для приведения строки можно воспользоваться функцией `to_tsvector`:
```sql
select to_tsvector('ты вчера был в гостях в Москве?');

to_tsvector
-----------------------------
 'вчер':2 'гост':5 'москв':7
```

Функция `to_tsvector` имеет частный случай использования, с явным указанием [[Языковая конфигурация|языковой конфигурации]]. Причем если указать конфигурацию не правильно, то функция отработает не верно:
```sql
#правильно
select to_tsvector('russian', 'ты вчера был в гостях в Москве?');

to_tsvector
-----------------------------
 'вчер':2 'гост':5 'москв':7

#не верно
select to_tsvector('english', 'ты вчера был в гостях в Москве?');

to_tsvector
--------------------------------------------------------
 'был':3 'в':4,6 'вчера':2 'гостях':5 'москве':7 'ты':1
```

>Прим.: посмотреть список установленных конфигураций можно командой `\dF`

### tsquery

Значение `tsquery` содержит **искомые лексемы**, объединяемые логическими операторами `&` (И), `|` (ИЛИ) и `!` (НЕ), а также оператором поиска фраз `<->` (ПРЕДШЕСТВУЕТ). Также допускается вариация оператора ПРЕДШЕСТВУЕТ вида ``<_`N`_>``, где _`N`_ — целочисленная константа, задающая расстояние между двумя искомыми лексемами. Запись оператора `<->` равнозначна `<1>`.

Для группировки операторов могут использоваться скобки. Без скобок эти операторы имеют разные приоритеты, в порядке убывания: `!` (НЕ), `<->` (ПРЕДШЕСТВУЕТ), `&` (И) и `|` (ИЛИ).

Надо обратить внимание, что `tsquery` содержит лексемы, объединенные операторами. Пример правильного использования и не правильного:
```sql
#правильно
select 'привет | мой & мир:*'::tsquery;

tsquery
----------------------------
 'привет' | 'мой' & 'мир':*
 
#не правильно
select 'привет мой мир'::tsquery;
ОШИБКА:  ошибка синтаксиса в tsquery: "привет мой мир"
```

В лексемах `tsquery` можно использовать знак `*` для поиска по префиксу.
Этот запрос найдёт все слова в `tsvector`, начинающиеся с приставки «super»:
```sql
SELECT 'super:*'::tsquery;

tsquery  
-----------
 'super':*
```

Для преобразования строки к `tsquery` существуют функции:
1. `to_tsquery()` - принимает слова, разделённые операторами и преобразует слова к лексемам
2. `plainto_tsquery()` - принимает любой текст
3. `phraseto_tsquery()` - принимает любой текст

Как и в случае с функцией `to_tsvector` первым аргументом можно указать [[Языковая конфигурация|языковую конфигурацию]].
Примеры:
```sql
#языковая кофигурация по умолчанию
select to_tsquery('привет | из | мира & джунглей');

to_tsquery
-----------------------------
 'привет' | 'мир' & 'джунгл'

#языковая кофигурация указана не верно
select to_tsquery('english', 'привет | из | мира & джунглей');
to_tsquery
---------------------------------------
 'привет' | 'из' | 'мира' & 'джунглей'
 
select plainto_tsquery('привет из мира джунглей');

plainto_tsquery
-----------------------------
 'привет' & 'мир' & 'джунгл'

select phraseto_tsquery('привет из мира джунглей');

phraseto_tsquery
---------------------------------
 'привет' <2> 'мир' <-> 'джунгл'
```

[Читай подробнее про tsvector и tsquery](https://postgrespro.ru/docs/postgrespro/9.5/datatype-textsearch)

#tsvector #tsquery